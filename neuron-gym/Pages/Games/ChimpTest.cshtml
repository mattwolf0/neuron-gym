@page
@model neuron_gym.Pages.Games.ChimpTestModel
@{
    ViewData["Title"] = "Chimp Test";
}

<h1>Chimp Test</h1>

<p>
    Circles appear at random positions with numbers inside. Memorize them while the countdown runs,
    then tap the circles in numeric order after the numbers disappear.
</p>

<div class="row mt-4">
    <div class="col-md-4 mb-3">
        <div class="border rounded p-3">
            <div class="d-flex justify-content-between">
                <span>Current level</span>
                <span id="chimp-level" class="fw-semibold">-</span>
            </div>
            <div class="d-flex justify-content-between mt-2">
                <span>Best level (this session)</span>
                <span id="chimp-best" class="fw-semibold">-</span>
            </div>
            <div class="d-flex justify-content-between mt-2">
                <span>Best score</span>
                <span class="fw-semibold">@Model.BestScore</span>
            </div>

            <a asp-page="/Scoreboard" class="btn btn-outline-secondary mt-3 w-100">
                Open scoreboard
            </a>

            <button id="chimp-start" class="btn btn-primary mt-2 w-100">
                Start game
            </button>
        </div>
    </div>

    <div class="col-md-8 mb-3">
        <div class="border rounded p-4 text-center">
            <div class="mb-3">
                <div id="chimp-play-area" class="chimp-play-area mx-auto">
                    <div id="chimp-circles" class="chimp-circles-container"></div>
                    <div id="chimp-countdown" class="chimp-countdown"></div>
                </div>
            </div>
            <div id="chimp-status" class="mt-3 text-muted chimp-status">
                Press "Start game" to begin.
            </div>

            <div id="chimp-save-container" class="card mt-4 d-none">
                <div class="card-body">
                    <h5 class="card-title">Save your score</h5>
                    <p class="card-text">
                        Your final level: <span id="chimp-final-score-text"></span>
                    </p>

                    <form method="post" asp-page-handler="SaveScore">
                        <input asp-for="ScoreValue" type="hidden" id="chimp-score-value" />
                        <div class="mb-3">
                            <label asp-for="PlayerName" class="form-label">Name</label>
                            <input asp-for="PlayerName" class="form-control" id="chimp-player-name" />
                            <span asp-validation-for="PlayerName" class="text-danger"></span>
                        </div>
                        <button type="submit" class="btn btn-success me-2">Save score</button>
                        <a asp-page="/Games/ChimpTest" class="btn btn-secondary">Cancel</a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const playArea = document.getElementById("chimp-play-area");
            const circlesContainer = document.getElementById("chimp-circles");
            const countdownElement = document.getElementById("chimp-countdown");
            const statusText = document.getElementById("chimp-status");
            const levelText = document.getElementById("chimp-level");
            const bestText = document.getElementById("chimp-best");
            const startButton = document.getElementById("chimp-start");

            const saveContainer = document.getElementById("chimp-save-container");
            const scoreValueInput = document.getElementById("chimp-score-value");
            const finalScoreText = document.getElementById("chimp-final-score-text");
            const playerNameInput = document.getElementById("chimp-player-name");

            let level = 1;
            let bestLevel = 0;
            let circles = [];
            let nextExpected = 1;
            let inputEnabled = false;
            let countdownTimer = null;

            function resetSaveBox() {
                if (saveContainer) {
                    saveContainer.classList.add("d-none");
                }
                if (playerNameInput) {
                    playerNameInput.value = "";
                }
            }

            function generateCircles() {
                circlesContainer.innerHTML = "";

                const width = playArea.clientWidth;
                const height = playArea.clientHeight;

                const size = 64;
                const margin = 16;
                const placed = [];

                const maxX = width - size - margin;
                const maxY = height - size - margin;

                for (let n = 1; n <= level; n++) {
                    let x;
                    let y;
                    let attempts = 0;

                    do {
                        x = Math.random() * (maxX - margin) + margin;
                        y = Math.random() * (maxY - margin) + margin;
                        attempts++;
                    } while (
                        placed.some(p => {
                            const dx = p.x - x;
                            const dy = p.y - y;
                            return Math.sqrt(dx * dx + dy * dy) < size + 10;
                        }) &&
                        attempts < 50
                    );

                    placed.push({ x, y });

                    const circle = document.createElement("button");
                    circle.type = "button";
                    circle.className = "chimp-circle";
                    circle.style.left = x + "px";
                    circle.style.top = y + "px";
                    circle.textContent = n.toString();
                    circle.dataset.order = n.toString();
                    circle.addEventListener("click", handleCircleClick);
                    circlesContainer.appendChild(circle);
                }

                circles = Array.from(circlesContainer.querySelectorAll(".chimp-circle"));
                nextExpected = 1;
                inputEnabled = false;
            }

            function startCountdown() {
                let value = 3;

                countdownElement.textContent = value.toString();
                countdownElement.classList.add("chimp-countdown-visible");

                if (countdownTimer) {
                    clearInterval(countdownTimer);
                }

                countdownTimer = setInterval(function () {
                    value--;

                    if (value > 0) {
                        countdownElement.textContent = value.toString();
                    } else {
                        clearInterval(countdownTimer);
                        countdownTimer = null;
                        countdownElement.textContent = "Go!";
                        setTimeout(function () {
                            countdownElement.textContent = "";
                            countdownElement.classList.remove("chimp-countdown-visible");
                            hideNumbers();
                        }, 400);
                    }
                }, 1000);
            }

            function hideNumbers() {
                circles.forEach(function (c) {
                    c.textContent = "";
                    c.classList.add("chimp-circle-hidden");
                });
                inputEnabled = true;
                statusText.textContent = "Tap the circles in numeric order.";
            }

            function startRound() {
                resetSaveBox();
                generateCircles();
                levelText.textContent = level.toString();
                statusText.textContent = "Memorize the numbers while the countdown runs.";
                startCountdown();
            }

            function handleCircleClick(e) {
                if (!inputEnabled) {
                    return;
                }

                const circle = e.currentTarget;
                const order = parseInt(circle.dataset.order);

                if (order === nextExpected) {
                    circle.classList.remove("chimp-circle-hidden");
                    circle.classList.add("chimp-circle-correct");
                    circle.textContent = order.toString();
                    nextExpected++;

                    if (nextExpected > level) {
                        inputEnabled = false;
                        statusText.textContent = "Correct. Next level is coming.";

                        if (level > bestLevel) {
                            bestLevel = level;
                            if (bestText) {
                                bestText.textContent = bestLevel.toString();
                            }
                        }

                        level++;
                        setTimeout(function () {
                            startRound();
                        }, 1200);
                    }
                } else {
                    inputEnabled = false;
                    circle.classList.remove("chimp-circle-hidden");
                    circle.classList.add("chimp-circle-wrong");
                    circle.textContent = order.toString();

                    const finalScore = level;

                    statusText.textContent =
                        "Wrong circle. Game over at level " +
                        level +
                        ". You can save your score or start a new game.";

                    circles.forEach(function (c) {
                        if (c !== circle) {
                            c.classList.remove("chimp-circle-hidden");
                            c.textContent = c.dataset.order;
                        }
                    });

                    if (scoreValueInput && finalScoreText && saveContainer) {
                        scoreValueInput.value = finalScore.toString();
                        finalScoreText.textContent = finalScore.toString();
                        saveContainer.classList.remove("d-none");
                        if (playerNameInput) {
                            playerNameInput.focus();
                        }
                    }

                    level = 1;
                    nextExpected = 1;
                }
            }

            if (startButton) {
                startButton.addEventListener("click", function () {
                    if (bestLevel === 0 && bestText) {
                        bestText.textContent = "-";
                    }
                    level = 1;
                    startRound();
                });
            }
        });
    </script>
}
