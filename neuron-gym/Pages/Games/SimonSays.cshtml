@page
@model neuron_gym.Pages.Games.SimonSaysModel
@{
    ViewData["Title"] = "Simon Says";
}

<h1>Simon Says</h1>

<p>
    Watch the sequence of highlighted squares, then repeat it by clicking the squares in the same order.
</p>

<div class="row mt-4">
    <div class="col-md-4 mb-3">
        <div class="border rounded p-3">
            <div class="d-flex justify-content-between">
                <span>Current level</span>
                <span id="simon-level" class="fw-semibold">-</span>
            </div>
            <div class="d-flex justify-content-between mt-2">
                <span>Best level (this session)</span>
                <span id="simon-best" class="fw-semibold">-</span>
            </div>
            <div class="d-flex justify-content-between mt-2">
                <span>Best score</span>
                <span class="fw-semibold">@Model.BestScore</span>
            </div>

            <a asp-page="/Scoreboard" class="btn btn-outline-secondary mt-3 w-100">
                Open scoreboard
            </a>

            <button id="simon-start" class="btn btn-primary mt-2 w-100">
                Start game
            </button>
        </div>
    </div>

    <div class="col-md-8 mb-3">
        <div class="border rounded p-4 text-center">
            <div class="mb-3">
                <div id="simon-grid" class="simon-grid mx-auto"></div>
            </div>
            <div id="simon-status" class="mt-3 text-muted">
                Press "Start game" to begin.
            </div>

            <div id="simon-save-container" class="card mt-4 d-none">
                <div class="card-body">
                    <h5 class="card-title">Save your score</h5>
                    <p class="card-text">
                        Your final level: <span id="simon-final-score-text"></span>
                    </p>

                    <form method="post" asp-page-handler="SaveScore">
                        <input asp-for="ScoreValue" type="hidden" id="simon-score-value" />
                        <div class="mb-3">
                            <label asp-for="PlayerName" class="form-label">Name</label>
                            <input asp-for="PlayerName" class="form-control" id="simon-player-name" />
                            <span asp-validation-for="PlayerName" class="text-danger"></span>
                        </div>
                        <button type="submit" class="btn btn-success me-2">Save score</button>
                        <a asp-page="/Games/SimonSays" class="btn btn-secondary">Cancel</a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const grid = document.getElementById("simon-grid");
            const statusText = document.getElementById("simon-status");
            const levelText = document.getElementById("simon-level");
            const bestText = document.getElementById("simon-best");
            const startButton = document.getElementById("simon-start");

            const saveContainer = document.getElementById("simon-save-container");
            const scoreValueInput = document.getElementById("simon-score-value");
            const finalScoreText = document.getElementById("simon-final-score-text");
            const playerNameInput = document.getElementById("simon-player-name");

            let sequence = [];
            let userIndex = 0;
            let level = 0;
            let bestLevel = 0;
            let inputEnabled = false;
            let isPlayingBack = false;

            function resetSaveBox() {
                if (saveContainer) {
                    saveContainer.classList.add("d-none");
                }
                if (playerNameInput) {
                    playerNameInput.value = "";
                }
            }

            function buildGrid() {
                grid.innerHTML = "";
                for (let i = 0; i < 9; i++) {
                    const cell = document.createElement("button");
                    cell.type = "button";
                    cell.className = "simon-cell";
                    cell.dataset.index = i.toString();
                    cell.addEventListener("click", handleCellClick);
                    grid.appendChild(cell);
                }
            }

            function getCell(index) {
                return grid.querySelector('[data-index="' + index + '"]');
            }

            function addStep() {
                const next = Math.floor(Math.random() * 9);
                sequence.push(next);
                level = sequence.length;
                levelText.textContent = level.toString();
            }

            function playSequence() {
                inputEnabled = false;
                isPlayingBack = true;
                userIndex = 0;
                statusText.textContent = "Watch the sequence.";

                let i = 0;
                const flashDuration = 500;
                const gap = 180;

                function flashNext() {
                    if (i >= sequence.length) {
                        isPlayingBack = false;
                        inputEnabled = true;
                        statusText.textContent = "Repeat the sequence by clicking the squares.";
                        return;
                    }

                    const idx = sequence[i];
                    const cell = getCell(idx);
                    if (!cell) {
                        return;
                    }

                    cell.classList.add("simon-cell-active");
                    setTimeout(function () {
                        cell.classList.remove("simon-cell-active");
                        i++;
                        setTimeout(flashNext, gap);
                    }, flashDuration);
                }

                flashNext();
            }

            function startRound() {
                resetSaveBox();
                addStep();
                playSequence();
            }

            function handleCellClick(e) {
                if (!inputEnabled || isPlayingBack) {
                    return;
                }

                const cell = e.currentTarget;
                const index = parseInt(cell.dataset.index);

                const expected = sequence[userIndex];

                if (index === expected) {
                    cell.classList.add("simon-cell-correct");
                    setTimeout(function () {
                        cell.classList.remove("simon-cell-correct");
                    }, 200);

                    userIndex++;

                    if (userIndex === sequence.length) {
                        inputEnabled = false;
                        if (level > bestLevel) {
                            bestLevel = level;
                            bestText.textContent = bestLevel.toString();
                        }
                        statusText.textContent = "Correct. Next level is coming.";
                        setTimeout(function () {
                            startRound();
                        }, 1000);
                    }
                } else {
                    inputEnabled = false;
                    cell.classList.add("simon-cell-wrong");

                    const finalScore = level;

                    statusText.textContent =
                        "Wrong square. Game over at level " +
                        finalScore +
                        ". You can save your score or start a new game.";

                    if (scoreValueInput && finalScoreText && saveContainer) {
                        scoreValueInput.value = finalScore.toString();
                        finalScoreText.textContent = finalScore.toString();
                        saveContainer.classList.remove("d-none");
                        if (playerNameInput) {
                            playerNameInput.focus();
                        }
                    }

                    sequence = [];
                    level = 0;
                    levelText.textContent = "-";
                }
            }

            startButton.addEventListener("click", function () {
                resetSaveBox();
                sequence = [];
                level = 0;
                levelText.textContent = "-";
                if (bestLevel === 0) {
                    bestText.textContent = "-";
                }
                statusText.textContent = "Watch the sequence.";
                startRound();
            });

            buildGrid();
        });
    </script>
}
