@page
@model neuron_gym.Pages.Games.NumberMemoryModel
@{
    ViewData["Title"] = "Number Memory";
}

<h1>Number Memory</h1>

<p>
    A number will be shown in the box below. Memorize it, then start typing.
    As soon as you press a key, the number disappears and you must enter it from memory.
</p>

<div class="row mt-4">
    <div class="col-md-4 mb-3">
        <div class="border rounded p-3">
            <div class="d-flex justify-content-between">
                <span>Current level</span>
                <span id="nm-level" class="fw-semibold">-</span>
            </div>
            <div class="d-flex justify-content-between mt-2">
                <span>Best level (this session)</span>
                <span id="nm-best" class="fw-semibold">-</span>
            </div>
            <div class="d-flex justify-content-between mt-2">
                <span>Best score</span>
                <span class="fw-semibold">@Model.BestScore</span>
            </div>

            <a asp-page="/Scoreboard" class="btn btn-outline-secondary mt-3 w-100">
                Open scoreboard
            </a>

            <button id="nm-start" class="btn btn-primary mt-2 w-100">
                Start game
            </button>
        </div>
    </div>

    <div class="col-md-8 mb-3">
        <div class="border rounded p-4 text-center">
            <div class="mb-3">
                <input id="nm-input"
                       type="text"
                       class="form-control form-control-lg text-center mx-auto"
                       style="max-width: 360px; font-size: 2.3rem; letter-spacing: 0.18em;"
                       autocomplete="off"
                       inputmode="numeric" />
            </div>
            <button id="nm-submit" class="btn btn-outline-primary">
                Submit
            </button>
            <div id="nm-status" class="mt-3 text-muted">
                Press "Start game" to begin.
            </div>

            <div id="nm-save-container" class="card mt-4 d-none">
                <div class="card-body">
                    <h5 class="card-title">Save your score</h5>
                    <p class="card-text">
                        Your final level: <span id="nm-final-score-text"></span>
                    </p>

                    <form method="post" asp-page-handler="SaveScore">
                        <input asp-for="ScoreValue" type="hidden" id="nm-score-value" />
                        <div class="mb-3">
                            <label asp-for="PlayerName" class="form-label">Name</label>
                            <input asp-for="PlayerName" class="form-control" id="nm-player-name" />
                            <span asp-validation-for="PlayerName" class="text-danger"></span>
                        </div>
                        <button type="submit" class="btn btn-success me-2">Save score</button>
                        <a asp-page="/Games/NumberMemory" class="btn btn-secondary">Cancel</a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const levelText = document.getElementById("nm-level");
            const bestText = document.getElementById("nm-best");
            const input = document.getElementById("nm-input");
            const status = document.getElementById("nm-status");
            const startBtn = document.getElementById("nm-start");
            const submitBtn = document.getElementById("nm-submit");

            const saveContainer = document.getElementById("nm-save-container");
            const scoreValueInput = document.getElementById("nm-score-value");
            const finalScoreText = document.getElementById("nm-final-score-text");
            const playerNameInput = document.getElementById("nm-player-name");

            let level = 1;
            let bestLevel = 0;
            let currentNumber = "";
            let typingStarted = false;

            function resetSaveBox() {
                if (saveContainer) {
                    saveContainer.classList.add("d-none");
                }
                if (playerNameInput) {
                    playerNameInput.value = "";
                }
            }

            function generateNumber(length) {
                let s = "";
                for (let i = 0; i < length; i++) {
                    const digit = i === 0
                        ? Math.floor(Math.random() * 9) + 1
                        : Math.floor(Math.random() * 10);
                    s += digit.toString();
                }
                return s;
            }

            function startRound() {
                typingStarted = false;
                currentNumber = generateNumber(level);
                levelText.textContent = level.toString();
                input.value = currentNumber;
                input.focus();
                status.textContent = "Memorize the number. Start typing when you are ready.";
            }

            function checkAnswer() {
                if (!typingStarted) {
                    status.textContent = "Start typing to hide the number first.";
                    input.focus();
                    return;
                }

                const value = input.value.trim();

                if (value.length === 0) {
                    status.textContent = "Please type the number.";
                    input.focus();
                    return;
                }

                if (value === currentNumber) {
                    if (level > bestLevel) {
                        bestLevel = level;
                        bestText.textContent = bestLevel.toString();
                    }
                    status.textContent = "Correct. Next level is coming.";
                    level++;
                    setTimeout(function () {
                        startRound();
                    }, 900);
                } else {
                    const finalLevel = level;

                    status.textContent =
                        "Incorrect. The correct number was " +
                        currentNumber +
                        ". Game over at level " +
                        finalLevel +
                        ". You can save your score or start a new game.";

                    if (scoreValueInput && finalScoreText && saveContainer) {
                        scoreValueInput.value = finalLevel.toString();
                        finalScoreText.textContent = finalLevel.toString();
                        saveContainer.classList.remove("d-none");
                        if (playerNameInput) {
                            playerNameInput.focus();
                        }
                    }

                    level = 1;
                    typingStarted = false;
                }
            }

            function handleKeyDown(e) {
                if (!typingStarted) {
                    typingStarted = true;
                    e.preventDefault();
                    input.value = "";
                    status.textContent = "Type the number from memory, then press Enter or Submit.";
                    return;
                }

                if (e.key === "Enter") {
                    e.preventDefault();
                    checkAnswer();
                }
            }

            startBtn.addEventListener("click", function () {
                resetSaveBox();
                if (bestLevel === 0) {
                    bestText.textContent = "-";
                }
                level = 1;
                startRound();
            });

            input.addEventListener("keydown", handleKeyDown);

            submitBtn.addEventListener("click", function () {
                checkAnswer();
            });
        });
    </script>
}
